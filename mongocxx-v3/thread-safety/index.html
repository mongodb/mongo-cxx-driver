<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<meta name="keyword" content="">

    <link rel="shortcut icon" href="https://mongodb.github.io/mongo-cxx-driver/img/favicon.png">

    <title>Thread safety</title>

    <link rel="stylesheet" href="https://mongodb.github.io/mongo-cxx-driver/lib/bootstrap.css" type="text/css" />
<link rel="stylesheet" href="https://mongodb.github.io/mongo-cxx-driver/lib/font-awesome/css/font-awesome.min.css" type="text/css" />
<link rel="stylesheet" href="https://mongodb.github.io/mongo-cxx-driver/css/mongodb-docs.css" type="text/css" />
<link rel="stylesheet" href="https://mongodb.github.io/mongo-cxx-driver/css/overrides.css" type="text/css" />
<link rel="stylesheet" href="https://mongodb.github.io/mongo-cxx-driver/lib/highlight/styles/idea.css" />

  </head>

  <body>
  
  <section id="container" class="">
      
      <header id="header-db" class="row" role="navigation">
  <div class="header-content">
    <div class="toggle-nav pull-left">
        <i class="fa fa-bars"></i>
        <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
    </div>
    
    <div class="logo pull-left">
      <a href="https://mongodb.github.io/mongo-cxx-driver">
        <img src="https://mongodb.github.io/mongo-cxx-driver/img/logo-mongodb-header.png",
             alt="MongoDB C++ driver" />
      </a>
    </div>
    
    <div>
<div class="nav-items pull-right">
  <a href="https://university.mongodb.com" data-toggle="tooltip" data-placement="bottom" title="Free Online Classes">MongoDB University</a>
  <a href="http://www.mongodb.org/downloads" data-toggle="tooltip" data-placement="bottom" title="Download MongoDB">Downloads</a>
  <a href="http://www.mongodb.org/get-involved" data-toggle="tooltip" data-placement="bottom" title="Get involved with MongoDB">Community</a>
  <a href="http://docs.mongodb.org" data-toggle="tooltip" data-placement="bottom" title="The MongoDB Documentation">Docs</a>
  <a href="http://blog.mongodb.org" data-toggle="tooltip" data-placement="bottom" title="The MongoDB Blog">Blog</a>
  <div id="search">
<form method="get" action="//www.google.com/search" target="_blank">
    <input type="text" name="searchQuery" size="20" value="" autocomplete="off" placeholder="Search docs">
    <input type="hidden" name="site" value="https://mongodb.github.io/mongo-cxx-driver">
    <input type="hidden" name="q" value="">
    <label for="searchQuery"><i class="fa fa-search fa-1"></i></label>
</form>
</div>

</div>
</div>

  </div>
</header>

      

      
<aside id="sidebar" class="sidebar">
    <div class="ssidebar nav-collapse">
      <div class="ssidebarwrapper">
        <h3>
          <a class="index-link" href="https://mongodb.github.io/mongo-cxx-driver">MongoDB C&#43;&#43; Driver Manual</a>
        </h3>

        
        <ul class="sidebar-menu">
          
          
          
          
          
          
          
          
          
          
          
          

          
          
            
            









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
  
  
  
  
  
  
  

  
    
    
    
  
  


        
      
    
      
      
        
      
    
      
      
    
    
  


          
            
            









  
    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    
  


          
            
            









  


          
            
            









  


          
            
            









  


          
            
            









  


          
            
            









  
    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    
  


          

          

          
            
            













  




<li class="toctree-l1  current">
  <a href="/mongo-cxx-driver/mongocxx-v3/" class="">
      <i class='fa fa-arrow-right'></i>
      <span>mongocxx (v3)</span>
      <span class="menu-arrow fa fa-angle-down"></span>
  </a>
    <ul  class="current">
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/mongocxx-v3/">
        
        Overview
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/mongocxx-v3/installation/">
        
        Installing the mongocxx driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/mongocxx-v3/configuration/">
        
        Configuring the mongocxx driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/mongocxx-v3/tutorial/">
        
        Tutorial for mongocxx
    </a>
  </li>


        
        
        
        
        













  




    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/mongocxx-v3/thread-safety/">
        
        Thread safety
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/mongocxx-v3/working-with-bson/">
        
        Working with BSON
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/mongocxx-v3/api-abi-versioning/">
        
        API and ABI versioning
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            
















<li class="toctree-l1 ">
  <a href="/mongo-cxx-driver/legacy-v1/" class="">
      <i class='fa fa-arrow-right'></i>
      <span>legacy (v1)</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/legacy-v1/">
        
        Overview
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/legacy-v1/installation/">
        
        Installing the legacy driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/legacy-v1/configuration/">
        
        Configuring the legacy driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/legacy-v1/tutorial/">
        
        Legacy driver tutorial
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/legacy-v1/working-with-bson/">
        
        Working with BSON
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/legacy-v1/breaking-changes/">
        
        Breaking changes from 26compat
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="https://mongodb.github.io/mongo-cxx-driver/api/current">
        <i class='fa fa-file-text-o'></i>
        API Documentation
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/mongo-cxx-driver/getting-help/">
        <i class='fa fa-question'></i>
        Getting help
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/mongo-cxx-driver/reporting-bugs/">
        <i class='fa fa-bug'></i>
        Reporting Bugs
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="https://github.com/mongodb/mongo-cxx-driver/">
        <i class='fa fa-github'></i>
        Source Code
    </a>
  </li>


          
            
            
















<li class="toctree-l1 ">
  <a href="/mongo-cxx-driver/contributing/" class="">
      <i class='fa fa-pencil'></i>
      <span>Contributing</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/contributing/">
        
        Contribution Guidelines
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/contributing/testing-mongocxx/">
        
        Testing the mongocxx driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/contributing/mongocxx-release-guide/">
        
        Releasing the mongocxx driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/contributing/testing-legacy/">
        
        Testing the legacy driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-cxx-driver/contributing/legacy-release-guide/">
        
        Releasing the legacy driver
    </a>
  </li>


        
        
    </ul>
  </li>


          
        </ul>
        
    </div>
  </div>
  
</aside>



      
      <section id="main-content" class="content">
          <section class="main-column pull-left">
            <div class="document">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body">


   
<a class="edit-link" href="https://github.com/mongodb/mongo-cxx-driver/blob/master/docs/content/mongocxx-v3/thread-safety.md" target="_blank" title="Edit mongocxx-v3/thread-safety.md on GitHub"><i class="fa fa-pencil-square-o"></i></a>










<div class="bc">
<ul>
  
  
  
  
  
  <li><a href="/mongo-cxx-driver/mongocxx-v3/">mongocxx (v3)</a> <i class="fa fa-angle-right"></i></li>
  <li>Thread safety</li>
</ul>
</div>




<p>TLDR: <strong>Always give each thread its own <code>mongocxx::client</code></strong>.</p>

<p>In general each <code>mongocxx::client</code> object AND all of its child objects
<strong>should be used by a single thread at a time</strong>.</p>

<p>Even if you create multiple child objects from a single <code>client</code>, and
synchronize them individually, that is unsafe as they will concurrently
modify internal structures of the <code>client</code>. The same is true if you copy a
child object.</p>

<h2 id="never-do-this">Never do this</h2>

<pre><code class="language-c++">mongocxx::instance instance{};
mongocxx::client c{};
auto db1 = c[&quot;db1&quot;];
auto db2 = c[&quot;db2&quot;];
std::mutex db1_mtx{};
std::mutex db2_mtx{};

auto threadfunc = [](mongocxx::database&amp; db, std::mutex&amp; mtx) {
    std::scoped_lock&lt;std::mutex&gt;(mtx);
    db[&quot;col&quot;].insert({});
}

// BAD! these two databases are individually synchronized, but they are derived from the same
// client, so they can only be accessed by one thread at a time
std::thread([]() { threadfunc(db1, db1_mtx); threadfunc(db2, db2_mtx); });
std::thread([]() { threadfunc(db2, db2_mtx); threadfunc(db1, db1_mtx); });
</code></pre>

<p>In the above example, even though the two databases are individually
synchronized, they are derived from the same client. There is shared state
inside the library that is now being modified without synchronization. The
same problem occurs if <code>db2</code> is a copy of <code>db1</code>.</p>

<h2 id="a-better-version">A better version</h2>

<pre><code class="language-c++">mongocxx::instance instance{};
mongocxx::client c1{};
mongocxx::client c2{}
std::mutex c1_mtx{};
std::mutex c2_mtx{};

auto threadfunc = [](stdx::string_view dbname, mongocxx::client&amp; client, std::mutex&amp; mtx) {
    std::scoped_lock&lt;std::mutex&gt;(mtx);
    client[dbname][&quot;col&quot;].insert({});
}

// Good! these two clients are individually synchronized, so it is safe to share them between
// threads.
std::thread([]() { threadfunc(&quot;db1&quot;, c1, c1_mtx); threadfunc(&quot;db2&quot;, c2, c2_mtx); });
std::thread([]() { threadfunc(&quot;db2&quot;, c2, c2_mtx); threadfunc(&quot;db1&quot;, c1, c1_mtx); });
</code></pre>

<h2 id="the-best-version">The best version</h2>

<pre><code class="language-c++">mongocxx::instance instance{};
auto threadfunc = [](mongocxx::client&amp; client, stdx::string_view dbname) {
    client[dbname][&quot;col&quot;].insert({});
}
// don't even bother sharing clients. Just give each thread its own,
std::thread([]() {
    mongocxx::client c{};
    threadfunc(c, &quot;db1&quot;);
    threadfunc(c, &quot;db2&quot;);
});

std::thread([]() {
    mongocxx::client c{};
    threadfunc(c, &quot;db2&quot;);
    threadfunc(c, &quot;db1&quot;);
});
</code></pre>

<p>In most programs, clients will be long lived - so its less of a hassle (and
more performant) to make one per-thread. Obviously in this contrived
example, there&rsquo;s quite a bit of overhead because we&rsquo;re doing so little work
with each client - but in a real program this is the best solution.</p>






<div id="btnv">
  
  <div class="pull-left">
  <a class="navigation prev" href="/mongo-cxx-driver/mongocxx-v3/tutorial/">
      <i class="fa fa-long-arrow-left"> </i> Tutorial for mongocxx
  </a>
  </div>
  
  
  <div class="pull-right">
  <a class="navigation next" href="/mongo-cxx-driver/mongocxx-v3/working-with-bson/">
    Working with BSON <i class="fa fa-long-arrow-right"> </i>
  </a>
  
</div>
</div>


</div>
<div class="right-column">
<div class="wrapper">
  
  <div class="toc">
    <span class="toc-header">On this page</span>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#never-do-this">Never do this</a></li>
<li><a href="#a-better-version">A better version</a></li>
<li><a href="#the-best-version">The best version</a></li>
</ul></li>
</ul>
</nav>
  </div>
  
</div>
</div>

</div>
</div>
</div>
</section>
</section>

</section>


<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
   URL_ROOT:    "https://mongodb.github.io/mongo-cxx-driver",
   VERSION:     "",
   COLLAPSE_INDEX: false,
   FILE_SUFFIX: '.html',
   HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="https://mongodb.github.io/mongo-cxx-driver/js/jquery.js"></script>
<script type="text/javascript" src="https://mongodb.github.io/mongo-cxx-driver/lib/bootstrap.js"></script>
<script type="text/javascript" src="https://mongodb.github.io/mongo-cxx-driver/js/navbar.js"></script>
<script type="text/javascript" src="https://mongodb.github.io/mongo-cxx-driver/lib/highlight/highlight.pack.js"></script>
<script type="text/javascript" src="https://mongodb.github.io/mongo-cxx-driver/js/scripts.js"></script>


<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-K75Z5Q"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
{'gtm.start': new Date().getTime(),event:'gtm.js'}
);var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K75Z5Q');</script>


<script type="text/javascript">
var _elqQ = _elqQ || [];
_elqQ.push(['elqSetSiteId', '413370795']);
_elqQ.push(['elqTrackPageView']);
(function () {
function async_load()
{ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//img03.en25.com/i/elqCfg.min.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }
if (window.addEventListener) window.addEventListener('DOMContentLoaded', async_load, false);
else if (window.attachEvent) window.attachEvent('onload', async_load);
})();
</script>

</body>
</html>

