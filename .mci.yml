#######################################
#      CXX Driver Config for MCI      #
#######################################

exec_timeout_secs: 3600

include:
  - filename: .evergreen/generated_configs/functions.yml
  - filename: .evergreen/generated_configs/tasks.yml
  - filename: .evergreen/generated_configs/task_groups.yml
  - filename: .evergreen/generated_configs/variants.yml

#######################################
#              Post Task              #
#######################################

post:
  - func: "stop_mongod"
  - func: "backtrace"
  # Workaround for CXX-2040
  # - func: "upload working dir"
  - func: "upload mongo orchestration artifacts"
  - func: "upload code coverage"

#######################################
#               Tasks                 #
#######################################

tasks:
    - name: compile_and_test_with_shared_libs
      commands:
        - func: "setup"
        - func: "start_mongod"
        - func: "fetch_c_driver_source"
        - func: "compile"
          vars:
              RUN_DISTCHECK: 1
        - func: "fetch-det"
        - func: "run_kms_servers"
        # Call "install_c_driver" before "test" to build static C driver libraries. Example projects require static C driver libraries.
        - func: "install_c_driver"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: single

    - name: compile_and_test_with_shared_libs_extra_alignment
      commands:
        - func: "setup"
        - func: "start_mongod"
        - func: "fetch_c_driver_source"
          vars:
              BSON_EXTRA_ALIGNMENT: 1
        - func: "compile"
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "install_c_driver"
          vars:
              BSON_EXTRA_ALIGNMENT: 1
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: single

    - name: compile_and_test_with_shared_libs_cxx20
      commands:
        - func: "setup"
        - func: "start_mongod"
        - func: "fetch_c_driver_source"
        - func: "compile"
          vars:
              RUN_DISTCHECK: 1
              REQUIRED_CXX_STANDARD: 20
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "install_c_driver"
        - func: "test"
          vars:
              example_projects_cxx_standard: 20
              MONGOCXX_TEST_TOPOLOGY: single
              REQUIRED_CXX_STANDARD: 20

    - name: compile_and_test_with_shared_libs_extra_alignment_cxx20
      commands:
        - func: "setup"
        - func: "start_mongod"
        - func: "fetch_c_driver_source"
          vars:
              BSON_EXTRA_ALIGNMENT: 1
        - func: "compile"
          vars:
              REQUIRED_CXX_STANDARD: 20
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "install_c_driver"
          vars:
              BSON_EXTRA_ALIGNMENT: 1
        - func: "test"
          vars:
              example_projects_cxx_standard: 20
              MONGOCXX_TEST_TOPOLOGY: single
              REQUIRED_CXX_STANDARD: 20

    - name: compile_with_shared_libs
      commands:
      - func: "setup"
      - func: "fetch_c_driver_source"
      - func: "compile"

    - name: compile_without_tests
      commands:
      - func: "setup"
      - func: "fetch_c_driver_source"
      - func: "compile"
        vars:
            ENABLE_TESTS: OFF

    - name: compile_and_run_benchmarks
      commands:
      - func: "setup"
      - func: "start_mongod"
      - func: "fetch_c_driver_source"
      - func: "compile_benchmarks"
      - func: "run benchmarks"

    - name: compile_macro_guard_tests
      commands:
      - func: "setup"
      - func: "fetch_c_driver_source"
      - func: "compile"
        vars:
            COMPILE_MACRO_GUARD_TESTS: ON

    - name: compile_and_test_auth_with_shared_libs
      commands:
        - func: "setup"
        - func: "start_mongod"
          vars:
              AUTH: auth
        - func: "fetch_c_driver_source"
        - func: "compile"
        - func: "test auth"
        - func: "test atlas connectivity"

    - name: compile_and_test_with_static_libs
      commands:
        - func: "setup"
        - func: "start_mongod"
        - func: "fetch_c_driver_source"
        - func: "compile"
          vars:
              USE_STATIC_LIBS: 1
              RUN_DISTCHECK: 1
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "install_c_driver"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: single
              USE_STATIC_LIBS: 1

    - name: compile_and_test_with_static_libs_extra_alignment
      commands:
        - func: "setup"
        - func: "start_mongod"
        - func: "fetch_c_driver_source"
          vars:
              BSON_EXTRA_ALIGNMENT: 1
        - func: "compile"
          vars:
              USE_STATIC_LIBS: 1
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "install_c_driver"
          vars:
              BSON_EXTRA_ALIGNMENT: 1
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: single
              USE_STATIC_LIBS: 1

    - name: compile_and_test_with_shared_libs_replica_set
      commands:
        - func: "setup"
        - func: "start_mongod"
          vars:
              TOPOLOGY: "replica_set"
        - func: "fetch_c_driver_source"
        - func: "compile"
          vars:
              RUN_DISTCHECK: 1
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "install_c_driver"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: replica

    - name: compile_and_test_with_shared_libs_sharded_cluster
      commands:
        - func: "setup"
        - func: "start_mongod"
          vars:
              TOPOLOGY: "sharded_cluster"
        - func: "fetch_c_driver_source"
        - func: "compile"
          vars:
              RUN_DISTCHECK: 1
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "install_c_driver"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: sharded

    # Auto downloading the C driver in the C++ build does not currently include
    # support for libmongocrypt, therefore it is not configured with
    # -DENABLE_CLIENT_SIDE_ENCRYPTION=ON. For now, CSFLE tests will need to have
    # a manually configured C driver, hence the need to seperate this task.
    - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
      commands:
        - func: "setup"
        - func: "start_mongod"
          vars:
              TOPOLOGY: "replica_set"
        - func: "install_c_driver"
        - func: "compile"
          vars:
              RUN_DISTCHECK: 1
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: replica

    - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt
      commands:
        - func: "setup"
        - func: "start_mongod"
          vars:
              TOPOLOGY: "sharded_cluster"
        - func: "install_c_driver"
        - func: "compile"
          vars:
              RUN_DISTCHECK: 1
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: sharded

    - name: build_example_with_add_subdirectory
      commands:
      - func: "setup"
      - func: "start_mongod"
      - command: shell.exec
        type: test
        params:
          working_dir: "mongo-cxx-driver"
          shell: bash
          script: |-
            set -o errexit
            cd examples/add_subdirectory
            [ -d mongo-c-driver ] || git clone --depth 1 https://github.com/mongodb/mongo-c-driver
            rsync -aq --exclude='examples/add_subdirectory' $(readlink -f ../..) .
            [ -d build ] || mkdir build
            . ./mongo-c-driver/.evergreen/scripts/find-cmake-latest.sh
            export cmake_binary
            cmake_binary="$(find_cmake_latest)"
            # Use ccache if available.
            . ./mongo-c-driver/.evergreen/scripts/find-ccache.sh
            find_ccache_and_export_vars "$(pwd)" || true
            command -v "$cmake_binary"
            "$cmake_binary" -S . -B build -DENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF
            "$cmake_binary" --build build
            ./build/hello_mongocxx

    - name: test_versioned_api
      commands:
        - func: "setup"
        - func: "start_mongod"
          vars:
              REQUIRE_API_VERSION: true
              # Authentication with versioned API should already be tested
              # in the C driver.
              AUTH: noauth
        - func: "fetch_c_driver_source"
        - func: "compile"
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: single
              MONGODB_API_VERSION: 1

    - name: test_versioned_api_accept_version_two
      commands:
        - func: "setup"
        - func: "start_mongod"
          vars:
              ORCHESTRATION_FILE: versioned-api-testing.json
              AUTH: noauth
        - func: "fetch_c_driver_source"
        - func: "compile"
        - func: "fetch-det"
        - func: "run_kms_servers"
        - func: "test"
          vars:
              MONGOCXX_TEST_TOPOLOGY: single

#######################################
#           Buildvariants             #
#######################################

buildvariants:
    #######################################
    #  Standard MongoDB Integration Tests #
    #######################################
    - name: integration-ubuntu2004-latest-single
      display_name: "Ubuntu 20.04 Debug (MongoDB Latest)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu2004-8.0-single
      display_name: "Ubuntu 20.04 Debug (MongoDB 8.0)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "8.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu2004-7.0-single
      display_name: "Ubuntu 20.04 Debug (MongoDB 7.0)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "7.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu1804-6.0-single
      display_name: "Ubuntu 18.04 Debug (MongoDB 6.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "6.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu1804-5.0-single
      display_name: "Ubuntu 18.04 Debug (MongoDB 5.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "5.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu1804-4.4-single
      display_name: "Ubuntu 18.04 Debug (MongoDB 4.4)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.4"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu1804-4.2-single
      display_name: "Ubuntu 18.04 Debug (MongoDB 4.2)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.2"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu1804-4.0-single
      display_name: "Ubuntu 18.04 Debug (MongoDB 4.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-latest-single
      display_name: "Windows (VS 2019) Debug (MongoDB Latest)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-8.0-single
      display_name: "Windows (VS 2019) Debug (MongoDB 8.0)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "8.0"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-7.0-single
      display_name: "Windows (VS 2019) Debug (MongoDB 7.0)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "7.0"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-6.0-single
      display_name: "Windows (VS 2019) Debug (MongoDB 6.0)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "6.0"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-5.0-single
      display_name: "Windows (VS 2019) Debug (MongoDB 5.0)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "5.0"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-4.4-single
      display_name: "Windows (VS 2019) Debug (MongoDB 4.4)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "4.4"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-4.2-single
      display_name: "Windows (VS 2019) Debug (MongoDB 4.2)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "4.2"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-vs2019-4.0-single
      display_name: "Windows (VS 2019) Debug (MongoDB 4.0)"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "4.0"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_with_shared_libs
        - name: compile_and_test_with_shared_libs_extra_alignment

    - name: integration-ubuntu2004-latest-replica
      display_name: "Ubuntu 20.04 Debug replica set (MongoDB Latest)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu2004-8.0-replica
      display_name: "Ubuntu 20.04 Debug replica set (MongoDB 8.0)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "8.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu2004-7.0-replica
      display_name: "Ubuntu 20.04 Debug replica set (MongoDB 7.0)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "7.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu1804-6.0-replica
      display_name: "Ubuntu 18.04 Debug replica set (MongoDB 6.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "6.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu1804-5.0-replica
      display_name: "Ubuntu 18.04 Debug replica set (MongoDB 5.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "5.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu1804-4.4-replica
      display_name: "Ubuntu 18.04 Debug replica set (MongoDB 4.4)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.4"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu1804-4.2-replica
      display_name: "Ubuntu 18.04 Debug replica set (MongoDB 4.2)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.2"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu1804-4.0-replica
      display_name: "Ubuntu 18.04 Debug replica set (MongoDB 4.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt

    - name: integration-ubuntu2004-latest-sharded
      display_name: "Ubuntu 20.04 Debug sharded cluster (MongoDB Latest)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-ubuntu2004-8.0-sharded
      display_name: "Ubuntu 20.04 Debug sharded cluster (MongoDB 8.0)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "8.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-ubuntu2004-7.0-sharded
      display_name: "Ubuntu 20.04 Debug sharded cluster (MongoDB 7.0)"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "7.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-ubuntu1804-6.0-sharded
      display_name: "Ubuntu 18.04 Debug sharded cluster (MongoDB 6.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "6.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-ubuntu1804-5.0-sharded
      display_name: "Ubuntu 18.04 Debug sharded cluster (MongoDB 5.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "5.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-ubuntu1804-4.4-sharded
      display_name: "Ubuntu 18.04 Debug sharded cluster (MongoDB 4.4)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.4"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-ubuntu1804-4.2-sharded
      display_name: "Ubuntu 18.04 Debug sharded cluster (MongoDB 4.2)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.2"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-ubuntu1804-4.0-sharded
      display_name: "Ubuntu 18.04 Debug sharded cluster (MongoDB 4.0)"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.0"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-auth-ubuntu2004-latest-single
      display_name: "Ubuntu 20.04 Debug Latest Auth"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: compile_and_test_auth_with_shared_libs

    - name: integration-auth-vs2017-latest-single
      display_name: "Windows (VS 2017) Debug Latest Auth"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 15 2017
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_auth_with_shared_libs

    - name: integration-auth-vs2019-latest-single
      display_name: "Windows (VS 2019) Debug Latest Auth"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: compile_and_test_auth_with_shared_libs

    - name: integration-versioned-api-ubuntu2004-latest-single
      display_name: "Ubuntu 20.04 Debug Latest Versioned API"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
        - name: test_versioned_api
        - name: test_versioned_api_accept_version_two

    - name: integration-versioned-api-vs2019-latest-single
      display_name: "Windows (VS 2019) Debug Latest Versioned API"
      run_on: windows-vsCurrent-large
      expansions:
          mongodb_version: "latest"
          build_type: "Debug" # Same for Windows and Linux
          generator: Visual Studio 16 2019
          platform: x64
          example_projects_cxx_standard: 17
      tasks:
        - name: test_versioned_api
        - name: test_versioned_api_accept_version_two

    - name: integration-mongocryptd-ubuntu2004-latest
      display_name: "Ubuntu 20.04 Debug (MongoDB Latest) with mongocryptd"
      run_on: ubuntu2004-large
      expansions:
          mongodb_version: "latest"
          use_mongocryptd: true
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
          # "Drivers MUST run all tests with mongocryptd on at least one platform for all tested server versions (4.2+)."
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-mongocryptd-ubuntu1804-5.0
      display_name: "Ubuntu 18.04 Debug (MongoDB 5.0) with mongocryptd"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "5.0"
          use_mongocryptd: true
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
          # "Drivers MUST run all tests with mongocryptd on at least one platform for all tested server versions (4.2+)."
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-mongocryptd-ubuntu1804-4.4
      display_name: "Ubuntu 18.04 Debug (MongoDB 4.4) with mongocryptd"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.4"
          use_mongocryptd: true
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
          # "Drivers MUST run all tests with mongocryptd on at least one platform for all tested server versions (4.2+)."
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    - name: integration-mongocryptd-ubuntu1804-4.2
      display_name: "Ubuntu 18.04 Debug (MongoDB 4.2) with mongocryptd"
      run_on: ubuntu1804-large
      expansions:
          mongodb_version: "4.2"
          use_mongocryptd: true
          build_type: "Debug"
          ENABLE_CODE_COVERAGE: ON
      tasks:
          # "Drivers MUST run all tests with mongocryptd on at least one platform for all tested server versions (4.2+)."
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt

    #######################################
    #         Linux Buildvariants         #
    #######################################

    - name: rhel9-release-latest
      display_name: "RHEL 9 Release (MongoDB Latest)"
      expansions:
          build_type: "Release"
          mongodb_version: "latest"
          lib_dir: "lib64"
      run_on:
          - rhel90-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_cxx20
          - name: compile_and_test_with_shared_libs_extra_alignment_cxx20
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt
          - name: build_example_with_add_subdirectory

    - name: benchmarks-rhel9
      display_name: "Benchmarks (RHEL 9.2)"
      expansions:
          mongodb_version: "v6.0-perf"
      run_on: rhel90-dbx-perf-large
      tasks:
          - name: compile_and_run_benchmarks

    - name: arm-rhel9-release-latest
      display_name: "arm64 RHEL 9 Release (MongoDB Latest)"
      expansions:
          build_type: "Release"
          mongodb_version: "latest"
          lib_dir: "lib64"
      run_on:
          - rhel90-arm64-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_cxx20
          - name: compile_and_test_with_shared_libs_extra_alignment_cxx20
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt
          - name: build_example_with_add_subdirectory

    - name: debian12-release-latest
      display_name: "Debian 12 Release (MongoDB Latest)"
      expansions:
          build_type: "Release"
          mongodb_version: "latest"
      run_on:
          - debian12-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_cxx20
          - name: compile_and_test_with_shared_libs_extra_alignment_cxx20
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt
          - name: build_example_with_add_subdirectory

    - name: debian11-release-50
      display_name: "Debian 11 Release (MongoDB 5.0)"
      expansions:
          build_type: "Release"
          mongodb_version: "5.0"
      run_on:
          - debian11-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_cxx20
          - name: compile_and_test_with_shared_libs_extra_alignment_cxx20
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set
          - name: compile_and_test_with_shared_libs_sharded_cluster
          - name: build_example_with_add_subdirectory

    - name: debian10-release-50
      display_name: "Debian 10 Release (MongoDB 5.0)"
      expansions:
          build_type: "Release"
          mongodb_version: "5.0"
      run_on:
          - debian10-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set
          - name: compile_and_test_with_shared_libs_sharded_cluster
          - name: build_example_with_add_subdirectory

    - name: ubuntu2004-release-latest
      display_name: "Ubuntu 20.04 Release (MongoDB Latest)"
      expansions:
          build_type: "Release"
          mongodb_version: "latest"
      run_on:
          - ubuntu2004-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set_with_libmongocrypt
          - name: compile_and_test_with_shared_libs_sharded_cluster_with_libmongocrypt
          - name: build_example_with_add_subdirectory

    - name: ubuntu2004-release-50
      display_name: "Ubuntu 20.04 Release (MongoDB 5.0)"
      expansions:
          build_type: "Release"
          mongodb_version: "5.0"
      run_on:
          - ubuntu2004-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set
          - name: compile_and_test_with_shared_libs_sharded_cluster
          - name: build_example_with_add_subdirectory

    - name: ubuntu1804-release-50
      display_name: "Ubuntu 18.04 Release (MongoDB 5.0)"
      expansions:
          build_type: "Release"
          mongodb_version: "5.0"
      run_on:
          - ubuntu1804-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment
          - name: compile_and_test_with_shared_libs_replica_set
          - name: compile_and_test_with_shared_libs_sharded_cluster
          - name: build_example_with_add_subdirectory

    - name: ubuntu2004-debug-valgrind-latest
      display_name: "Valgrind Ubuntu 20.04 Debug (MongoDB Latest)"
      expansions:
          build_type: "Debug"
          TEST_WITH_VALGRIND: "ON"
          mongodb_version: "latest"
          disable_slow_tests: 1
          use_mongocryptd: true  # false positives arise from the crypt_shared library
      run_on:
          - ubuntu2004-build
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: ubuntu1804-debug-valgrind-50
      display_name: "Valgrind Ubuntu 18.04 Debug (MongoDB 5.0)"
      expansions:
          build_type: "Debug"
          TEST_WITH_VALGRIND: "ON"
          mongodb_version: "5.0"
          disable_slow_tests: 1
          use_mongocryptd: true
      run_on:
          - ubuntu1804-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: ubuntu2004-debug-asan-latest
      display_name: "ASAN Ubuntu 20.04 Debug (MongoDB Latest)"
      expansions:
          build_type: "Debug"
          cc_compiler: clang
          cxx_compiler: clang++
          USE_SANITIZER_ASAN: ON
          TEST_WITH_ASAN: "ON"
          mongodb_version: "latest"
          example_projects_cc: clang
          example_projects_cxx: clang++
          example_projects_cxxflags: -D_GLIBCXX_USE_CXX11_ABI=0 -fsanitize=address -fno-omit-frame-pointer
          example_projects_ldflags: -fsanitize=address
      run_on:
          - ubuntu2004-build
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: ubuntu1804-debug-asan-50
      display_name: "ASAN Ubuntu 18.04 Debug (MongoDB 5.0)"
      expansions:
          build_type: "Debug"
          cc_compiler: clang
          cxx_compiler: clang++
          USE_SANITIZER_ASAN: ON
          TEST_WITH_ASAN: "ON"
          mongodb_version: "5.0"
          example_projects_cc: clang
          example_projects_cxx: clang++
          example_projects_cxxflags: -D_GLIBCXX_USE_CXX11_ABI=0 -fsanitize=address -fno-omit-frame-pointer
          example_projects_ldflags: -fsanitize=address
      run_on:
          - ubuntu1804-large
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: ubuntu2004-debug-ubsan-latest
      display_name: "UBSAN Ubuntu 20.04 Debug (MongoDB Latest)"
      expansions:
          build_type: "Debug"
          cc_compiler: clang
          cxx_compiler: clang++
          USE_SANITIZER_UBSAN: ON
          TEST_WITH_UBSAN: "ON"
          mongodb_version: "latest"
          example_projects_cc: clang
          example_projects_cxx: clang++
          example_projects_cxxflags: -D_GLIBCXX_USE_CXX11_ABI=0 -fsanitize=undefined -fno-sanitize-recover=undefined -fno-omit-frame-pointer
          example_projects_ldflags: -fsanitize=undefined -fno-sanitize-recover=undefined
      run_on:
          - ubuntu2004-build
      tasks:
          # We currently don't run UBSAN on the shared library due to issues with UBSAN reporting
          # numerous false positive instances of undefined behavior in the mock tests, when the
          # driver invokes mock callback functions that have libmongoc types in the callback
          # signature.
          - name: compile_and_test_with_static_libs

    - name: ubuntu1804-debug-ubsan-50
      display_name: "UBSAN Ubuntu 18.04 Debug (MongoDB 5.0)"
      expansions:
          build_type: "Debug"
          cc_compiler: clang
          cxx_compiler: clang++
          USE_SANITIZER_UBSAN: ON
          TEST_WITH_UBSAN: "ON"
          mongodb_version: "5.0"
          example_projects_cc: clang
          example_projects_cxx: clang++
          example_projects_cxxflags: -D_GLIBCXX_USE_CXX11_ABI=0 -fsanitize=undefined -fno-sanitize-recover=undefined -fno-omit-frame-pointer
          example_projects_ldflags: -fsanitize=undefined -fno-sanitize-recover=undefined
      run_on:
          - ubuntu1804-large
      tasks:
          # We currently don't run UBSAN on the shared library due to issues with UBSAN reporting
          # numerous false positive instances of undefined behavior in the mock tests, when the
          # driver invokes mock callback functions that have libmongoc types in the callback
          # signature.
          - name: compile_and_test_with_static_libs

    - name: ubuntu2004-debug
      display_name: "Ubuntu 20.04 Debug (MongoDB Latest) (Extra)"
      expansions:
        build_type: "Debug"
        mongodb_version: "latest"
      run_on:
        - ubuntu2004-build
      tasks:
        - name: compile_without_tests
        - name: compile_macro_guard_tests

    - name: ubuntu2004-debug-gcc
      display_name: "Ubuntu 20.04 Debug (GCC)"
      expansions:
        build_type: "Debug"
        mongodb_version: "latest"
        cc_compiler: gcc
        cxx_compiler: g++
      run_on:
        - ubuntu2004-large
      tasks:
        - name: compile_without_tests
        - name: compile_macro_guard_tests

    - name: ubuntu2004-debug-clang
      display_name: "Ubuntu 20.04 Debug (Clang)"
      expansions:
        build_type: "Debug"
        mongodb_version: "latest"
        cc_compiler: clang
        cxx_compiler: clang++
      run_on:
        - ubuntu2004-large
      tasks:
        - name: compile_without_tests
        - name: compile_macro_guard_tests

    - name: zseries-rhel83-latest
      display_name: "zSeries RHEL 8.3 (MongoDB Latest)"
      patchable: false
      batchtime: 1440 # 1 day
      expansions:
          build_type: "Release"
          mongodb_version: "latest"
          cmake: "cmake"
          lib_dir: "lib64"
      run_on:
          - rhel83-zseries-large
      tasks:
          - name: compile_with_shared_libs
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: zseries-rhel83-60
      display_name: "zSeries RHEL 8.3 (MongoDB 6.0)"
      patchable: false
      batchtime: 1440 # 1 day
      expansions:
          build_type: "Release"
          mongodb_version: "6.0"
          cmake: "cmake"
          lib_dir: "lib64"
      run_on:
          - rhel83-zseries-large
      tasks:
          - name: compile_with_shared_libs
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: zseries-rhel83-50
      display_name: "zSeries RHEL 8.3 (MongoDB 5.0)"
      patchable: false
      batchtime: 1440 # 1 day
      expansions:
          build_type: "Release"
          mongodb_version: "5.0"
          cmake: "cmake"
          lib_dir: "lib64"
      run_on:
          - rhel83-zseries-large
      tasks:
          - name: compile_with_shared_libs
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: power8-rhel81-latest
      display_name: "ppc64le RHEL 8.1 (MongoDB Latest)"
      patchable: false
      batchtime: 1440 # 1 day
      expansions:
          build_type: "Release"
          mongodb_version: "latest"
          cmake: "cmake"
          lib_dir: "lib64"
      run_on:
          - rhel81-power8-large
      tasks:
          - name: compile_with_shared_libs
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: power8-rhel81-50
      display_name: "ppc64le RHEL 8.1 (MongoDB 5.0)"
      patchable: false
      batchtime: 1440 # 1 day
      expansions:
          build_type: "Release"
          mongodb_version: "5.0"
          cmake: "cmake"
          lib_dir: "lib64"
      run_on:
          - rhel81-power8-large
      tasks:
          - name: compile_with_shared_libs
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: arm-ubuntu2004-latest
      display_name: "arm64 Ubuntu 20.04 (MongoDB Latest)"
      batchtime: 1440 # 1 day
      expansions:
          build_type: "Release"
          mongodb_version: "latest"
      run_on:
          - ubuntu2004-arm64-build
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: arm-ubuntu1804-50
      display_name: "arm64 Ubuntu 18.04 (MongoDB 5.0)"
      batchtime: 1440 # 1 day
      expansions:
          build_type: "Release"
          mongodb_version: "5.0"
      run_on:
          - ubuntu1804-arm64-build
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    #######################################
    #         Mac and Windows             #
    #######################################
    - name: macos-1100-latest
      display_name: "MacOS 11.0 Release (Boost) (MongoDB Latest)"
      expansions:
          build_type: "Release"
          BSONCXX_POLYFILL: "boost"
          mongodb_version: "latest"
      run_on:
          - macos-1100
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: macos-1100-50
      display_name: "MacOS 11.0 Release (Boost) (MongoDB 5.0)"
      expansions:
          build_type: "Release"
          BSONCXX_POLYFILL: "boost"
          mongodb_version: "5.0"
      run_on:
          - macos-1100
      tasks:
          - name: compile_and_test_with_shared_libs
          - name: compile_and_test_with_shared_libs_extra_alignment
          - name: compile_and_test_with_static_libs
          - name: compile_and_test_with_static_libs_extra_alignment

    - name: macos-1100-versioned-api
      display_name: "MacOS 11.0 Release Versioned API"
      expansions:
          build_type: "Release"
          BSONCXX_POLYFILL: "boost"
          mongodb_version: "latest"
      run_on:
          - macos-1100
      tasks:
          - name: test_versioned_api
          - name: test_versioned_api_accept_version_two

    - name: windows-2k8-release
      display_name: "Windows (VS 2015) Release (MongoDB 4.2)"
      expansions:
          build_type: "Release"
          mongodb_version: "4.2"
          generator: Visual Studio 14 2015
          platform: x64
      run_on:
          - windows-64-vs2015-compile
      tasks:
          - name: compile_without_tests

    - name: windows-2k8-debug
      display_name: "Windows (VS 2015) Debug Static (MongoDB 4.2)"
      expansions:
          build_type: "Debug"
          mongodb_version: "4.2"
          generator: Visual Studio 14 2015
          platform: x64
      run_on:
          - windows-64-vs2015-compile
      tasks:
          - name: compile_without_tests

    - name: windows-msvc2015-debug
      display_name: "Windows (VS 2015) Debug (MongoDB 4.2)"
      expansions:
          build_type: "Debug"
          generator: Visual Studio 14 2015
          platform: x64
          mongodb_version: "4.2"
      run_on:
         - windows-64-vs2015-compile
      tasks:
         - name: compile_without_tests

    - name: rhel79-compile
      display_name: "RHEL 7.9 (gcc 4.8.5)"
      expansions:
          build_type: "Release"
          BSONCXX_POLYFILL: impls
      run_on:
          - rhel79-large
      tasks:
          - name: compile_without_tests
