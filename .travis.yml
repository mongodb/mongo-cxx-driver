language: cpp
sudo: false

services: mongodb

addons:
  apt:
    packages: &common_packages
      - gdb

compiler:
  - gcc
  - clang

matrix:
  fast_finish: true
  include:
    - compiler: gcc
      env: CONFIG=Debug
      addons: &common_addons
        apt:
          sources: [ mongodb-3.4-precise ]
          packages: [ mongodb-org, *common_packages ]
    - compiler: gcc
      env: CONFIG=Release
      addons: *common_addons
    - compiler: clang
      env: CONFIG=Debug
      addons: *common_addons
    - compiler: clang
      env: CONFIG=Release
      addons: *common_addons

env:
    global:
        - MONGO_REPO="http://repo.mongodb.com/apt/ubuntu"
        - REPO_TYPE="precise/mongodb-enterprise/3.2 multiverse"
        - SOURCES_LOC="/etc/apt/sources.list.d/mongodb-enterprise.list"
        - KEY_SERVER="hkp://keyserver.ubuntu.com:80"
        - CMAKE_VERSION="cmake-3.2.3-Linux-x86_64"
        - CMAKE_BINARY="${CMAKE_VERSION}/bin/cmake"

    matrix:
        - CONFIG=Release
        - CONFIG=Debug

before_install:
    # Mongo C Driver
    - git clone https://github.com/mongodb/mongo-c-driver.git

install:
    # GCC
    - if [ "$CXX" = "g++" ]; then sudo apt-get install -qq g++-4.9; export CXX="g++-4.9"; export CC="gcc-4.9"; fi

    # Clang
    - if [ "$CXX" == "clang++" ]; then sudo apt-get install --allow-unauthenticated -qq clang-3.6; export CXX="clang++-3.6"; export CC="clang-3.6"; fi

    # Install Mongo C Driver
    - pushd mongo-c-driver

    - git checkout 1.7.0

    - git submodule update --init --recursive

    - ./autogen.sh --enable-tests=no --enable-examples=no --with-libbson=bundled; make; sudo make install

    - popd

before_script:
    - $CC --version
    - $CXX --version

    # Build the driver and the tests
    - cd build
    - cmake -DCMAKE_BUILD_TYPE=$CONFIG -DCMAKE_C_FLAGS="-Wall -Wextra -Wno-attributes -Werror -Wno-error=missing-field-initializers" -DCMAKE_CXX_FLAGS="-Wall -Wextra -Wno-attributes -Werror -Wno-error=missing-field-initializers" ..

script:
    - make format-lint

    - make all

    # Run bsoncxx tests with catch
    - ./src/bsoncxx/test/test_bson

    # Run mongocxx tests with catch
    - ./src/mongocxx/test/test_driver

    # Run mongocxx instance tests with catch
    - ./src/mongocxx/test/test_instance

    # Install headers and libs for the examples
    - make install

    # Make the examples
    - make examples

    # Run the examples
    - make run-examples
