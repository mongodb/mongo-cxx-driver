#!/bin/bash

# Runs cmake and compiles the standard build targets (all, install, examples).  Any arguments passed
# to this script will be forwarded on as flags passed to cmake.
#
# This script should be run from the root of the repository.  This script will run the build from
# the default build directory './build'.  The following environment variables will change the
# behavior of this script:
# - BUILD_TYPE: must be set to "Release" or "Debug"

set -o errexit
set -o pipefail

if [ "$BUILD_TYPE" != "Debug" -a "$BUILD_TYPE" != "Release" ]; then
    echo "$0: expected BUILD_TYPE environment variable to be set to 'Debug' or 'Release'" >&2
    exit 1
fi

OS=$(uname -s | tr '[:upper:]' '[:lower:]')

if [ -f /proc/cpuinfo ]; then
    CMAKE_BUILD_PARALLEL_LEVEL=$(grep -c ^processor /proc/cpuinfo)
elif which sysctl; then
    CMAKE_BUILD_PARALLEL_LEVEL=$(sysctl -n hw.logicalcpu)
else
    echo "$0: can't figure out what build parallel level to use" >&2
    exit 1
fi
export CMAKE_BUILD_PARALLEL_LEVEL

case "$OS" in
   darwin|linux)
      CMAKE_EXAMPLES_TARGET=examples
      if [ "$RUN_DISTCHECK" ]; then
         _RUN_DISTCHECK=$RUN_DISTCHECK
      fi
      ;;

   cygwin*)
      CMAKE_BUILD_OPTS="/verbosity:minimal"
      CMAKE_EXAMPLES_TARGET=examples/examples
      ;;

   *)
      echo "$0: unsupported platform '$OS'" >&2
      exit 2
      ;;
esac

cd build

cmake_flags=(
   -DCMAKE_BUILD_TYPE=${BUILD_TYPE}
   -DCMAKE_PREFIX_PATH="${MONGOC_PREFIX:?}"
   -DBUILD_TESTING=ON
   -DMONGOCXX_ENABLE_SLOW_TESTS=ON
   -DCMAKE_INSTALL_PREFIX=install
   -DENABLE_UNINSTALL=ON
   ${ADDL_OPTS:-}
)

case "${OSTYPE:?}" in
cygwin)
   case "${generator:-}" in
   *2015*) cmake_flags+=(-DBOOST_ROOT=C:/local/boost_1_60_0) ;;
   *2017*) cmake_flags+=(-DCMAKE_CXX_STANDARD=17) ;;
   *) echo "missing CMake Generator on Windows distro" 1>&2; exit 1 ;;
   esac
   ;;
darwin*|linux*)
   : ${generator:="Unix Makefiles"}
   ;;
*)
   echo "unrecognized operating system ${OSTYPE:?}" 1>&2
   exit 1
   ;;
esac
export CMAKE_GENERATOR="${generator:?}"

if [[ "${USE_POLYFILL_STD_EXPERIMENTAL:-}" == "ON" ]]; then
   cmake_flags+=(-DCMAKE_CXX_STANDARD=14 -DBSONCXX_POLY_USE_STD_EXPERIMENTAL=ON)
fi

if [[ "${USE_POLYFILL_BOOST:-}" == "ON" ]]; then
   cmake_flags+=(-DBSONCXX_POLY_USE_BOOST=ON)
fi
 
cc_flags_init=(-Wall -Wextra -Wno-attributes -Werror -Wno-missing-field-initializers)
cxx_flags_init=(-Wall -Wextra -Wconversion -Wnarrowing -pedantic -Werror)
cc_flags=()
cxx_flags=()

case "${OSTYPE:?}" in
cygwin)
   ;;
darwin*)
   cc_flags+=("${cc_flags_init[@]}")
   cxx_flags+=("${cxx_flags_init[@]}" -stdlib=libc++)
   ;;
linux*)
   cc_flags+=("${cc_flags_init[@]}")
   cxx_flags+=("${cxx_flags_init[@]}" -Wno-expansion-to-defined -Wno-missing-field-initializers)
   ;;
*)
   echo "unrecognized operating system ${OSTYPE:?}" 1>&2
   exit 1
   ;;
esac

# Sanitizers overwrite the usual compiler flags.
if [[ "${USE_SANITIZER_ASAN:-}" == "ON" ]]; then
   cxx_flags=(
      "${cxx_flags_init[@]}"
      -D_GLIBCXX_USE_CXX11_ABI=0
      -fsanitize=address
      -O1 -g -fno-omit-frame-pointer
   )
fi
if [[ "${USE_SANITIZER_UBSAN:-}" == "ON" ]]; then
   cxx_flags=(
      "${cxx_flags_init[@]}"
      -D_GLIBCXX_USE_CXX11_ABI=0
      -fsanitize=undefined
      -fsanitize-blacklist="$(pwd)/../etc/ubsan.ignorelist"
      -fno-sanitize-recover=undefined
      -O1 -g -fno-omit-frame-pointer
   )
fi

# Ignore warnings generated by core::optional in mnmlstc/core.
if [[ "${HOSTTYPE:?}" == powerpc64le ]]; then
   cxx_flags+=(-Wno-error=maybe-uninitialized)
fi

# Ignore deprecation warnings when building on a release branch.
if [ "$(echo "${branch_name:?}" | cut -f2 -d'/')" != "${branch_name:?}" ]; then
   cc_flags+=(-Wno-deprecated-declarations)
   cxx_flags+=(-Wno-deprecated-declarations)
fi

if [[ "${#cc_flags[@]}" > 0 ]]; then
   cmake_flags+=("-DCMAKE_C_FLAGS=${cc_flags[*]}")
fi

if [[ "${#cxx_flags[@]}" > 0 ]]; then
   cmake_flags+=("-DCMAKE_CXX_FLAGS=${cxx_flags[*]}")
fi

echo "Configuring with CMake flags: ${cmake_flags[*]}"

"${cmake_binary}" "${cmake_flags[@]}" ..

if [[ "${COMPILE_MACRO_GUARD_TESTS:-"OFF"}" == "ON" ]]; then
   # We only need to compile the macro guard tests.
   "${cmake_binary}" -DENABLE_MACRO_GUARD_TESTS=ON ..
   "${cmake_binary}" --build . --config $BUILD_TYPE --target test_bsoncxx_macro_guards test_mongocxx_macro_guards -- $CMAKE_BUILD_OPTS
   exit # Nothing else to be done.
fi

# Regular build and install routine.
"${cmake_binary}" --build . --config $BUILD_TYPE -- $CMAKE_BUILD_OPTS
"${cmake_binary}" --build . --config $BUILD_TYPE --target install -- $CMAKE_BUILD_OPTS
"${cmake_binary}" --build . --config $BUILD_TYPE --target $CMAKE_EXAMPLES_TARGET -- $CMAKE_BUILD_OPTS

if [ "$_RUN_DISTCHECK" ]; then
  "${cmake_binary}" --build . --config $BUILD_TYPE --target distcheck
fi
